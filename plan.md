# Terraspiel - Alchemy Pixel Playground

## コンセプト

[sandspiel.club](https://sandspiel.club/) のようなピクセルベースの物理シミュレーション（フォーリングサンドゲーム）に、要素を組み合わせて新しい要素を作る「錬金術（アルケミー）」の概念を組み合わせたアプリケーション。

## 技術スタック

- フロントエンドUI
React + TypeScript + Zustand + Tailwind CSS

- ゲームエンジン
Phaser 3
（WebGLモード）

- 物理・合成ロジック
自前グリッド物理 + ReactionRuleマネージャー（TypeScriptで実装）

- 描画最適化
Phaser DynamicTexture + カスタムシェーダ（必要に応じて）

- データ永続化
Zustand + localStorage（拡張：Firebase）

- サウンド
Howler.js

- ビルド・バンドル
Vite（高速HMR + 本番最適化）

- ホスティング
Vercel / Netlify（静的サイトとしてデプロイ可能）
http://localhost:5173/

## UI

1.  **要素選択:**
    - EMPTY以外の基本要素を選択。
    - 選択した状態でシミュレーションエリアを左クリックで配置する。
    - 画面上部中央

2.  **その他:**
    - キャンバスの要素をすべて消す　CLEAR
    - テスト用にランダムに要素を配置する　RANDOM
    - 画面上部右

3.  **デバッグ情報表示:**
    - 総数、各要素の数を見れるようにする
    - FPS表示

## 主な機能

1.  **基本要素:**
    - アルケミーの基本となる四大元素（+空）をベースにする。
    - EMPTY以外はユーザーが置ける
        -   `EMPTY` (空)
        -   `SOIL` (土)
        -   `WATER` (水)

2.  **物理演算と相互作用:**
    -   各要素に簡単な動きのルールを実装する。
        -   `SOIL`: 重力に従って下に落ちる。
        -   `WATER`: 下に流れ、左右に広がる。
        -   `MUD`: 水と同様だが、左右に広がりにくい。
        -   `CLAY`: SOILと同様だが、崩れにくい。
        -   `SAND`: 水と同様だが、少し左右に広がりにくい。
        -   `STONE`: SOILと同様だが、崩れない。
        -   `PEAT`: SOILと同様。
        -   `FERTILE_SOIL`: SOILと同様。
        -   `PLANT`: 詳細は４にて
        -   `OIL`: WATERより流動性がある。
        -   `MAGMA`: 少し流動性があり、重力でゆっくり落ちる。
        -   `CRYSTAL`: 重力に従って下に落ちる。

3. 接触による物質変化（錬金術）
    SOIL + WATER = MUD
    CRYSTAL + THUNDER → ELECTRUM（雷を閉じ込めた鉱石）
    CRYSTAL + FIRE → RUBY
    CRYSTAL + WATER → SAPPHIRE
    CRYSTAL + MUD → AMETHYST
    CRYSTAL + CLAY → GARNET
    CRYSTAL + PLANT → EMERALD
    WATER + STONE → LIMESTONE

4. 周囲の環境等による物質変化（非錬金術）
    ## 土壌
    - MUD + 周囲にWATERが存在しない + 時間経過 = CLAY
    - PEAT + 周囲にWATERが存在しない + 時間経過 = FIRE

    ## 雲(CLOUD)
    雲は確率で降雨カウンターをため、WATERを発生させる。
    雲は低確率で帯電カウンターをため、THUNDERを発生させる。
    雲は低確率で消滅カウンターをため、自然消滅する。
    雲と雲が隣接すると、消滅カウンターをリセットし、降雨カウンターと帯電カウンターを増加させる。

        ### 雷(THUNDER)
        THUNDERはほかの物質のようにピクセルで配置するのではなく粒子物理っぽく浮動小数点座標で管理。
        TUNDERが発生すると重力に従い斜め下方向にランダムに移動しながら、
        また軌跡を生じながら落下する。
        THUNDERがほかの物質に接触するとその周囲の物質を吹き飛ばす。さらに可燃性物質の場合は燃える。そして消える。

    ## 植物
    - FERTILE_SOIL 時間経過 = SEED
    - SEED + 時間経過 = PLANT
    - PLANT + 時間経過 = WITHERED_PLANT
    - WITHERED_PLANT + 時間経過 = OIL

      ### PLANTの生長
      - 発生する場所によって茎型植物と地被植物に分かれる。
      - 自身の上部にEMPTYしかない場合、地被植物となる
      - 自身の上部にEMPTY以外の物質がある場合、茎型植物となる
      - どちらの植物タイプも、確率で枯れるカウンターが上昇し、閾値を超えるとWITHERED_PLANTになる。
 
      ### 茎型植物の生長
      - 上方向または右上、左上方向に確率で伸びる。
      - 側面には花(FLOWER)や葉(LEAF)をランダムで生やす。

      ### 地被植物の生長
      - 左右のランダムな隣接する物質のすぐ近くにあるEMPTYセルに確率で増える。

      ### OIL
      - まれに自然発火する。


5. エーテル(ETHER)の発生と物質深化
物質が変化するとき、超低確率でエーテルという特別な粒子が生成される。
エーテルはランダムにその場をゆっくりと漂い一定時間で消滅する。
消滅する前にほかの物資に触れると確率で触れた物質を物質深化ルールに基づいた別の物質に変換する。

ETHERはほかの物質のようにピクセルで配置するのではなく粒子物理っぽく浮動小数点座標で管理。
見た目は淡く光る半透明な粒子って感じで。
 
    ** 物質深化ルール **
    - ETHER + SOIL = FERTILE_SOIL
    - ETHER + MUD = PEAT
    - ETHER + WATER = CLOUD
    - ETHER + STONE = CRYSTAL
        CRYSTALが発生するときに、発生に使われたETHER1つ分と、
        その周囲にETHERがあればそれらを自身が保有するETHER量にする。
        CRYSTAL は ETHER を低確率で放出する。さらに低確率でETHERを消費しない。
        すべてのETHERを放出すると破壊される。
    - BASALT + ETHER = OBSIDIAN

6. 燃焼による物質変化
何かの条件でFIREが発生した場合、その場に留まるパーティクルとして生成される。
FIREパーティクルは毎フレーム、自身の周囲8マスを確認し、燃焼可能な物質があれば確率で燃焼ルールに基づいた別の物質に変換する。
燃焼に成功した場合、元のFIREパーティクルは消滅し、燃焼が発生したセルに新しいFIREパーティクルが生成される（延焼）。
周囲に燃焼可能な物質がない場合、または隣接セルにWATERが存在する場合、FIREパーティクルは消滅する。

    ** 物質燃焼ルール **
    - FIRE + SOIL = SAND
    - FIRE + CLAY = STONE
    - FIRE + STONE = MAGMA

## セルベースの物理エンジン実装の工夫１
1. サブセル（fractional position）を持たせる
    見た目はセルにスナップして描画するけど、内部的には浮動小数点で位置や速度を持つ。

    例：

    X座標 = 10.3, Y座標 = 25.7

    毎フレーム 0.2, 0.4 ずつ加算していって、閾値超えたらセルを移動

    → 滑らかさがかなり増す (｀・ω・´)b

2. セル＋粒子のハイブリッド
    大域的な「環境」（土や水の塊）はセルで管理。
    特殊な要素（火花、種、生命）は粒子物理っぽく浮動小数点座標で管理。
    Minecraft の「水流」っぽい見せ方と、Noita の「粒子1個1個」みたいなのの中間。

3. 移動優先度のランダム化
    単純に下→左右の順で処理すると「縞模様」や「偏り」が出やすい。
    更新順序をランダムにしたり、確率で移動方向を選ばせると自然に見える。

4. 描画側で補間してごまかす
    内部はセル単位でも、レンダリング時に「補間フィルタ」をかける。
    粒子の縁をぼかす、移動軌跡をパーティクルっぽく描く → 人間の目には滑らかに見える。

5. 物理ベース流体の導入（高度だけど…）
    Lattice-Boltzmann 法（LBM）や Navier-Stokes の格子解法を使うと「流体らしさ」が爆上がりする。
    ただし計算コストが跳ね上がるので、セルサイズや領域を工夫しないと重い。

## セルベースで“自然に見える”工夫ネタ集
1. 擬似的な慣性
    速度を「確率」で表現する。
    例：落下中に「80%の確率で下に進む、20%で横に流れる」みたいにすると、直線落下じゃなく“ふわっ”とした動きが出せる。

2. 対角移動の解禁
    下が塞がってたら「左下・右下」に抜けられるようにする。
    ただし確率にした方が自然（毎回必ず斜め移動だとカクつく）。

3. 更新順序のランダム化
    上から順に処理すると“波打ち”や“カクカク”が目立つ。
    フレームごとにランダム順にセルを処理すると偏りが減って「生き物っぽい」動きになる。

4. 描画の工夫
    1セル = 1ドットじゃなく、グラデやアルファブレンドで「縁をぼかす」
    水は半透明＋周囲と色を少し混ぜる → 流体感が出る。
    土や火花はノイズを混ぜて粒感を出すとリアルになる。

5. 局所的な拡散
    セル移動とは別に「色や熱」だけ周囲に伝播させる。
    水分が染み込む
    熱が周囲にじわっと広がる
    → 動きは粗くても現象がリッチに見える

6. 低確率イベント
    火花が飛ぶ、泡が出る、煙がゆらぐ、エーテルが発生する（！）
    低確率で副作用を出すと、シミュレーション全体が“生きてる”感じに。

